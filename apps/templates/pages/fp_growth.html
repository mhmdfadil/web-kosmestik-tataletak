{% extends "/layouts/app.html" %}

{% block content %}
<style>
  .cards-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 20px;
    flex-wrap: wrap;
    margin-top: 40px;
  }
  
  .btn-action {
    width: 280px;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    border: none;
    outline: none;
  }
  
  .btn-proses {
    background-color: #298ca1;
    color: #ffffff;
  }
  
  .btn-proses:hover {
    background-color: #3ca2be;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
  }
  
  .btn-proses:disabled {
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.7;
  }
  
  .btn-lihat {
    background-color: #4f46e5;
    color: #ffffff;
  }
  
  .btn-lihat:hover {
    background-color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
  }
  
  .btn-lihat:disabled {
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.7;
  }
  
  .status-message {
    margin-top: 8px;
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  .status-success {
    color: #049464;
  }

  .status-danger {
    color: #c01515;
  }
  
  section.content {
    flex-grow: 1;
    background-color: #f9fafb;
    padding: 28px 40px;
    box-sizing: border-box;
    overflow-y: auto;
    font-family: 'Poppins', sans-serif;
  }
  
  .dataset-box {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 500;
    font-size: 18px;
    padding: 18px 24px;
    max-width: 100%;
    margin-bottom: 28px;
    background-color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    color: #374151;
  }
  
  .slider-container {
    max-width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 20px;
    background-color: white;
    padding: 20px 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .slider-container label {
    font-weight: 600;
    font-size: 16px;
    min-width: 180px;
    color: #1f2937;
  }
  
  .slider-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
  }
  
  .slider-container input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
    transition: background 0.3s;
    cursor: pointer;
  }
  
  .slider-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #1d4e63;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .slider-container input[type="range"]:hover::-webkit-slider-thumb {
    background: #2563eb;
    transform: scale(1.1);
  }
  
  .slider-value {
    font-weight: 600;
    font-size: 16px;
    min-width: 40px;
    color: #1f2937;
    text-align: center;
    background: #f3f4f6;
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    transition: all 0.3s ease;
  }
  
  .slider-value:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  
  .form-container {
    display: none;
  }
</style>

<!-- Content area -->
<section class="p-6 md:p-10 content mx-auto">
  <div class="dataset-box" aria-label="Dataset Aktif">
    Dataset Aktif: <strong>{{ file_info[1] if file_info[1] else '(Tidak Ada)' }}</strong>
  </div>
  
  <form id="setupForm" class="form-container" method="POST" action="{{ url_for('routes.setupfp') }}">
    <input type="hidden" id="minSupport" name="min_support_fp" value="{{ setup[3] if setup else 0 }}">
    <input type="hidden" id="minConfidence" name="min_confidance_fp" value="{{ setup[4] if setup else 0 }}">
  </form>

  <div class="slider-container">
    <label for="supportSlider">Minimum Support</label>
    <div class="slider-wrapper">
      <input
        type="range"
        id="supportSlider"
        min="0"
        max="100"
        step="1"
        value="{{ (setup[3] * 100) | round | int if setup else 0 }}"
      />
      <input
        type="number"
        class="slider-value"
        id="supportValue"
        min="0"
        max="100"
        value="{{ (setup[3] * 100) | round | int if setup else 0 }}"
      />
      <span>%</span>
    </div>
  </div>

  <div class="slider-container">
    <label for="confidenceSlider">Minimum Confidence</label>
    <div class="slider-wrapper">
      <input
        type="range"
        id="confidenceSlider"
        min="0"
        max="100"
        step="1"
        value="{{ (setup[4] * 100) | round | int if setup else 0 }}"
      />
      <input
        type="number"
        class="slider-value"
        id="confidenceValue"
        min="0"
        max="100"
        value="{{ (setup[4] * 100) | round | int if setup else 0 }}"
      />
      <span>%</span>
    </div>
  </div>

  <div class="cards-container">
    <div class="button-wrapper">
      {% if file_info %}
        {% if process[3] %}
          <!-- Already processed state -->
          <button class="btn-action btn-proses" type="button" disabled>
            Proses Perhitungan
          </button> 
          <p class="status-message status-success">Anda sudah memproses perhitungan ini.</p>
        {% else %}
          <!-- Ready to process state -->
          <form id="processForm" method="POST" action="{{ url_for('routes.process_fpgrowth') }}" class="hidden"></form>
          <button class="btn-action btn-proses" type="button" onclick="confirmProcess()">
            Proses Perhitungan
          </button>
        {% endif %}
      {% else %}
        <!-- No file info state -->
        <button class="btn-action btn-proses" type="button" disabled>
          Proses Perhitungan
        </button>
      {% endif %}
    </div>

    <div class="button-wrapper">
      {% if file_info %}
        {% if process[3] %}
        <!-- Tombol L]ihat -->
        <button class="btn-action btn-lihat" type="button" 
                onclick="window.location.href='{{ url_for('routes.calculate_fpgrowth') }}'">
          Lihat Perhitungan
        </button>
        {% else %}
          <button class="btn-action btn-lihat" type="button" disabled >
            Lihat Perhitungan
          </button>
          <p class="status-message status-danger">Anda belum memproses perhitungan.</p>
        {% endif %}
      {% else %}
        <button class="btn-action btn-lihat" type="button" disabled >
          Lihat Perhitungan
        </button>
      {% endif %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const supportSlider = document.getElementById('supportSlider');
    const confidenceSlider = document.getElementById('confidenceSlider');
    const supportValue = document.getElementById('supportValue');
    const confidenceValue = document.getElementById('confidenceValue');
    const minSupportInput = document.getElementById('minSupport');
    const minConfidenceInput = document.getElementById('minConfidence');
    const setupForm = document.getElementById('setupForm');

    // Function to update slider and value inputs
    function updateValues() {
      // Ensure values are within bounds
      let supportVal = Math.min(100, Math.max(0, parseInt(supportValue.value) || 0));
      let confidenceVal = Math.min(100, Math.max(0, parseInt(confidenceValue.value) || 0));
      
      // Update both slider and input values
      supportSlider.value = supportVal;
      supportValue.value = supportVal;
      
      confidenceSlider.value = confidenceVal;
      confidenceValue.value = confidenceVal;
      
      // Convert to decimal (0.0 to 1.0) and update hidden inputs
      minSupportInput.value = (supportVal / 100).toFixed(2);
      minConfidenceInput.value = (confidenceVal / 100).toFixed(2);
      
      // Submit the form
      setupForm.submit();
    }

    // Event listeners for sliders
    supportSlider.addEventListener('input', function() {
      supportValue.value = this.value;
      updateValues();
    });

    confidenceSlider.addEventListener('input', function() {
      confidenceValue.value = this.value;
      updateValues();
    });

    // Event listeners for input fields with debounce
    function setupInputListener(inputElement) {
      let timeout;
      inputElement.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          updateValues();
        }, 500);
      });
      
      inputElement.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          updateValues();
        }
      });
    }

    setupInputListener(supportValue);
    setupInputListener(confidenceValue);
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmProcess() {
    Swal.fire({
        title: 'Konfirmasi',
        text: 'Apakah kamu yakin ingin memproses perhitungan data ini?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#298ca1',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, proses!',
        cancelButtonText: 'Batal',
        backdrop: true,
        allowOutsideClick: false
    }).then((result) => {
        if (result.isConfirmed) {
            // Tampilkan loading
            Swal.fire({
                title: 'Memproses...',
                html: 'Data sedang diproses, harap tunggu.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Submit form secara manual
            document.getElementById('processForm').submit();
        }
    });
}
</script>
<script>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          {% for category, message in messages %}
                  Swal.fire({
                      title: '{{ "Pemrosesan Data Berhasil!" if category == "success" else
                              "Pemrosesan Data Berhasil!" if category == "danger" else
                              "Perhatian!" if category == "warning" else
                              "Informasi" }}',
                      text: '{{ message }}',
                      icon: '{{ "success" if category == "success" else
                              "error" if category == "danger" else
                              "warning" if category == "warning" else
                              "info" }}',
                      background: '{{ "#f0f9eb" if category == "success" else
                                    "#fde8e8" if category == "danger" else
                                    "#fff8e6" if category == "warning" else
                                    "#e8f4fd" }}',
                      color: '{{ "#0f5132" if category == "success" else
                              "#842029" if category == "danger" else
                              "#664d03" if category == "warning" else
                              "#055160" }}',
                      iconColor: '{{ "#28a745" if category == "success" else
                                  "#dc3545" if category == "danger" else
                                  "#ffc107" if category == "warning" else
                                  "#17a2b8" }}',
                      confirmButtonColor: '{{ "#28a745" if category == "success" else
                                          "#dc3545" if category == "danger" else
                                          "#ffc107" if category == "warning" else
                                          "#17a2b8" }}'
                  });
          {% endfor %}
      {% endif %}
    {% endwith %}
</script>

{% endblock %}