{% extends "/layouts/app.html" %}

{% block content %}

<style>
    /* Drag & Drop box style */
    .upload-box {
      border: 1px dashed #999;
      border-radius: 0.5rem;
      min-height: 380px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: border-color 0.3s ease;
      background-color: #f9fafb;
      user-select: none;
      padding: 20px;
      text-align: center;
    }
    .upload-box.dragover {
      border-color: #5a9bd8;
      background-color: #ebf4fb;
    }
    
    /* File preview container */
    .file-preview {
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f8f9fa;
      display: none;
    }
    
    .file-preview h3 {
      margin-top: 0;
      color: #298ca1;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow-x: auto;
      display: block;
    }
    
    .preview-table th, .preview-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    .preview-table th {
      background-color: #f2f2f2;
    }
    
    .preview-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    /* Responsive buttons */
    button.btn-upload {
      width: 100%;
      max-width: 200px;
      padding: 10px 0;
      background-color: #298ca1;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 10px;
      color: #d9e7ec;
      box-shadow: inset 0 -5px 10px rgba(255, 255, 255, 0.25), 0 6px 8px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }

    button.btn-upload:hover,
    button.btn-upload:focus {
      background-color: #3ca2be;
      outline: none;
    }

    button.btn-close {
      width: 100%;
      max-width: 200px;
      padding: 10px 0;
      border: 1px solid #298ca1;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 10px;
      color: #298ca1;
      background-color: white;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }

    button.btn-close:hover,
    button.btn-close:focus {
      background-color: #f0f0f0;
      outline: none;
    }
    
    /* Responsive layout */
    @media (max-width: 768px) {
      .upload-box {
        min-height: 250px;
        padding: 15px;
      }
      
      .upload-icon {
        width: 60px;
        height: 60px;
      }
      
      .button-container {
        flex-direction: column;
        align-items: center;
      }
      
      button.btn-upload, button.btn-close {
        width: 100%;
        max-width: none;
      }
    }
    
    /* Loading spinner */
    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #298ca1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
</style>

<!-- Content area -->
<section class="p-6 items-center justify-center">
      <form id="uploadForm" action="{{ url_for('routes.input') }}" method="POST" enctype="multipart/form-data" class="w-full flex flex-col gap-8">
        <!-- Drag and Drop upload box -->
        <label
          for="fileUpload"
          class="upload-box"
          id="uploadBox"
          tabindex="0"
          aria-label="Pilih file atau drag and drop file data transaksi CSV dan XLSX"
        >
          <!-- Upload cloud arrow icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="78" height="78" fill="#0066ff" class="bi bi-cloud-upload upload-icon" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
            <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
          </svg>
          <p class="text-base font-normal text-black select-none" style="font-size: 1.45em;">Select your files or drag and drop</p>
          <p class="font-light text-gray-600 select-none" style="font-size: 1.18em; margin-top: 7px;">CSV, XLSX accepted</p>
          <p id="selectedFileName" class="font-medium text-blue-600" style="display: none;"></p>

          <input
            type="file"
            id="fileUpload"
            name="file"
            accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
            class="hidden"
            required
          />
          <button
            type="button"
            onclick="document.getElementById('fileUpload').click();"
            class="mt-12 text-white py-2 px-8 rounded shadow btn-upload transition"
          >
            Browse
          </button>
        </label>
        
        <!-- File preview container -->
        <div id="filePreview" class="file-preview">
          <h3>File Preview</h3>
          <div id="previewContent"></div>
        </div>
        
        <div class="spinner" id="loadingSpinner"></div>

        <!-- Buttons for cancel and upload -->
        <div class="flex gap-6 justify-end w-full button-container">
          <button
            type="reset"
            id="cancelButton"
            class="border border-teal-600 text-teal-600 font-medium rounded btn-close hover:bg-teal-100 transition"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="uploadButton"
            class="text-white font-semibold rounded px-6 py-2 btn-upload transition"
            disabled
          >
            Upload
          </button>
        </div>
      </form>
      
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

   <script>
    document.addEventListener('DOMContentLoaded', function() {
      const uploadBox = document.getElementById('uploadBox');
      const fileInput = document.getElementById('fileUpload');
      const selectedFileName = document.getElementById('selectedFileName');
      const filePreview = document.getElementById('filePreview');
      const previewContent = document.getElementById('previewContent');
      const uploadButton = document.getElementById('uploadButton');
      const cancelButton = document.getElementById('cancelButton');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const uploadForm = document.getElementById('uploadForm');
      
      // Function to reset the form
      function resetForm() {
        fileInput.value = '';
        selectedFileName.style.display = 'none';
        filePreview.style.display = 'none';
        uploadButton.disabled = true;
        previewContent.innerHTML = '';
      }
      
      // Add dragover, dragleave, drop event listeners
      uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.classList.add('dragover');
      });

      uploadBox.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('dragover');
      });

      uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelection(e.dataTransfer.files[0]);
        }
      });

      // Handle file selection
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelection(e.target.files[0]);
        }
      });
      
      // Function to handle file selection and preview
      function handleFileSelection(file) {
        selectedFileName.textContent = `Selected file: ${file.name}`;
        selectedFileName.style.display = 'block';
        uploadButton.disabled = false;
        
        // Show loading spinner
        loadingSpinner.style.display = 'block';
        
        // Preview the file
        previewFile(file);
      }
      
      // Function to preview Excel or CSV file
      function previewFile(file) {
        const fileType = file.name.split('.').pop().toLowerCase();
        
        if (fileType === 'csv') {
          previewCSV(file);
        } else if (fileType === 'xlsx' || fileType === 'xls') {
          previewExcel(file);
        } else {
          previewContent.innerHTML = '<p>Preview not available for this file type.</p>';
          filePreview.style.display = 'block';
          loadingSpinner.style.display = 'none';
        }
      }
      
      // Function to preview CSV file
      function previewCSV(file) {
        Papa.parse(file, {
          header: true,
          preview: 25, // Only show first 25 rows
          complete: function(results) {
            if (results.errors.length > 0) {
              previewContent.innerHTML = `<p>Error parsing CSV: ${results.errors[0].message}</p>`;
            } else {
              displayPreviewTable(results.meta.fields, results.data);
            }
            filePreview.style.display = 'block';
            loadingSpinner.style.display = 'none';
          },
          error: function(error) {
            previewContent.innerHTML = `<p>Error parsing CSV: ${error.message}</p>`;
            filePreview.style.display = 'block';
            loadingSpinner.style.display = 'none';
          }
        });
      }
      
      // Function to preview Excel file
      function previewExcel(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Get first sheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length > 0) {
              const headers = jsonData[0];
              const rows = jsonData.slice(1, 26); // Show first 25 rows
              const formattedData = rows.map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                  obj[header] = row[i] !== undefined ? row[i] : '';
                });
                return obj;
              });
              displayPreviewTable(headers, formattedData);
            } else {
              previewContent.innerHTML = '<p>No data found in Excel sheet.</p>';
            }
          } catch (error) {
            previewContent.innerHTML = `<p>Error parsing Excel file: ${error.message}</p>`;
          }
          filePreview.style.display = 'block';
          loadingSpinner.style.display = 'none';
        };
        
        reader.onerror = function(error) {
          previewContent.innerHTML = `<p>Error reading Excel file: ${error.message}</p>`;
          filePreview.style.display = 'block';
          loadingSpinner.style.display = 'none';
        };
        
        reader.readAsArrayBuffer(file);
      }
      
      // Function to display preview table
      function displayPreviewTable(headers, data) {
        if (!headers || headers.length === 0) {
          previewContent.innerHTML = '<p>No headers found in the file.</p>';
          return;
        }
        
        let tableHTML = '<div style="overflow-x: auto;"><table class="preview-table"><thead><tr>';
        
        // Create header row
        headers.forEach(header => {
          tableHTML += `<th>${header}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';
        
        // Create data rows
        data.slice(0, 25).forEach(row => { // Limit to 25 rows for preview
          tableHTML += '<tr>';
          headers.forEach(header => {
            const value = row[header] !== undefined ? row[header] : '';
            tableHTML += `<td>${value}</td>`;
          });
          tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table><p class="mt-3">Showing first 25 rows</p></div>';
        previewContent.innerHTML = tableHTML;
      }
      
      // Cancel button handler
      cancelButton.addEventListener('click', resetForm);

      // Keyboard accessibility to trigger file dialog on Enter or Space key on the label
      uploadBox.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fileInput.click();
        }
      });

      // Form submission with SweetAlert confirmation
      uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files || fileInput.files.length === 0) {
          Swal.fire({
            icon: 'error',
            title: 'No File Selected',
            text: 'Please select a file to upload.',
            confirmButtonColor: '#298ca1',
          });
          return;
        }
        
        Swal.fire({
          title: 'Konfirmasi Unggah',
          html: `Mengunggah file ini akan <strong>menghapus semua data transaksi sebelumnya</strong>. Apakah Anda yakin ingin melanjutkan?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#298ca1',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Ya, unggah!',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            
            // Submit the form
            uploadForm.submit();
          }
        });
      });
    });
  </script>
<script>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          {% for category, message in messages %}
                  Swal.fire({
                      title: '{{ "Data Berhasil Diunggah!" if category == "success" else
                              "Data Gagal Diunggah!" if category == "danger" else
                              "Perhatian!" if category == "warning" else
                              "Informasi" }}',
                      text: '{{ message }}',
                      icon: '{{ "success" if category == "success" else
                              "error" if category == "danger" else
                              "warning" if category == "warning" else
                              "info" }}',
                      background: '{{ "#f0f9eb" if category == "success" else
                                    "#fde8e8" if category == "danger" else
                                    "#fff8e6" if category == "warning" else
                                    "#e8f4fd" }}',
                      color: '{{ "#0f5132" if category == "success" else
                              "#842029" if category == "danger" else
                              "#664d03" if category == "warning" else
                              "#055160" }}',
                      iconColor: '{{ "#28a745" if category == "success" else
                                  "#dc3545" if category == "danger" else
                                  "#ffc107" if category == "warning" else
                                  "#17a2b8" }}',
                      confirmButtonColor: '{{ "#28a745" if category == "success" else
                                          "#dc3545" if category == "danger" else
                                          "#ffc107" if category == "warning" else
                                          "#17a2b8" }}'
                  });
          {% endfor %}
      {% endif %}
    {% endwith %}
</script>
</section>

{% endblock %}